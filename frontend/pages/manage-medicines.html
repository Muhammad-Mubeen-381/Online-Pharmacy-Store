<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Medicines - Admin Panel</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="nav-logo" onclick="window.location.href='index.html'">
                <i class="fas fa-pills"></i>
                <span>PharmaStore</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="manage-medicines.html" class="nav-link active">Medicines</a>
                <a href="manage-orders.html" class="nav-link">Orders</a>
                <a href="manage-users.html" class="nav-link">Users</a>
                <a href="manage-categories.html" class="nav-link">Categories</a>
                <a href="inventory.html" class="nav-link">Inventory</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
                <div class="nav-actions">
                    <div class="admin-menu" id="adminMenu" style="display: none;">
                        <div class="user-dropdown">
                            <button class="admin-profile-btn" id="adminProfileBtn">
                                <i class="fas fa-user-shield"></i>
                                <span id="adminName"></span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown-menu" id="adminDropdownMenu">
                                <button class="dropdown-item" id="adminLogoutBtn">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Manage Medicines Section -->
    <section class="admin-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-pills"></i> Manage Medicines
                </h2>
                <button class="btn-primary" id="addMedicineBtn">
                    <i class="fas fa-plus"></i> Add New Medicine
                </button>
            </div>
            
            <div class="admin-search-bar">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="medicineSearch" placeholder="Search medicines..." class="search-box">
                </div>
                <select id="medicineCategoryFilter" class="filter-select">
                    <option value="">All Categories</option>
                </select>
            </div>
            
            <div class="medicines-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price (PKR)</th>
                            <th>Stock</th>
                            <th>Sales</th>
                            <th>Rating</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="medicinesTableBody">
                        <!-- Medicines will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 PharmaStore. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Add/Edit Medicine Modal -->
    <div class="modal" id="medicineModal">
        <div class="modal-content">
            <span class="close" id="closeMedicineModal">&times;</span>
            <h2 id="medicineModalTitle">Add New Medicine</h2>
            <form id="medicineForm">
                <div class="form-group">
                    <label for="medicineName">Medicine Name *</label>
                    <input type="text" id="medicineName" required>
                </div>
                <div class="form-group">
                    <label for="medicineDescription">Description *</label>
                    <textarea id="medicineDescription" rows="3" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="medicinePrice">Price (PKR) *</label>
                        <input type="number" id="medicinePrice" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="medicineStock">Stock Quantity *</label>
                        <input type="number" id="medicineStock" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="medicineCategory">Category *</label>
                        <select id="medicineCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="medicineRating">Rating</label>
                        <input type="number" id="medicineRating" step="0.1" min="0" max="5" value="4.0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="medicineImage">Image Emoji</label>
                    <input type="text" id="medicineImage" placeholder="üíä" maxlength="2">
                </div>
                <button type="submit" class="btn-primary">Save Medicine</button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <script src="../js/api-service.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/script.js"></script>
    <script>
        let editingMedicineId = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initializeApp === 'function') {
                initializeApp();
            }
            if (typeof setupEventListeners === 'function') {
                setupEventListeners();
            }
            if (typeof checkAuth === 'function') {
                checkAuth();
            }
            loadMedicinesTable();
            populateCategoryDropdown();
            
            document.getElementById('addMedicineBtn').addEventListener('click', () => {
                editingMedicineId = null;
                document.getElementById('medicineModalTitle').textContent = 'Add New Medicine';
                document.getElementById('medicineForm').reset();
                openModal(document.getElementById('medicineModal'));
            });
            
            document.getElementById('medicineForm').addEventListener('submit', handleMedicineSubmit);
            document.getElementById('medicineSearch').addEventListener('input', filterMedicinesTable);
            document.getElementById('medicineCategoryFilter').addEventListener('change', filterMedicinesTable);
        });
        
        async function loadMedicinesTable() {
            const tbody = document.getElementById('medicinesTableBody');
            
            try {
                // Load medicines from database
                if (typeof apiService !== 'undefined') {
                    const data = await apiService.getMedicines();
                    const medicinesList = data.medicines || data || [];
                    
                    if (medicinesList.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No medicines found. Add your first medicine!</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = medicinesList.map(med => `
                        <tr>
                            <td>${med.id}</td>
                            <td><strong>${med.name}</strong></td>
                            <td>${med.category_name || med.category || 'N/A'}</td>
                            <td>PKR ${med.price}</td>
                            <td><span class="stock-badge ${med.stock < 20 ? 'low-stock' : ''}">${med.stock || 0}</span></td>
                            <td>${med.sales || 0}</td>
                            <td>${med.rating || 0} ‚≠ê</td>
                            <td>
                                <button class="btn-edit-small" onclick="editMedicine(${med.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete-small" onclick="deleteMedicine(${med.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">API service not available</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load medicines:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Error loading medicines. Please try again.</td></tr>';
            }
        }
        
        async function populateCategoryDropdown() {
            const select = document.getElementById('medicineCategory');
            const filterSelect = document.getElementById('medicineCategoryFilter');
            
            try {
                if (typeof apiService !== 'undefined') {
                    const data = await apiService.getCategories();
                    const categoriesList = data.categories || data || [];
                    
                    // Clear existing options
                    select.innerHTML = '<option value="">Select Category</option>';
                    filterSelect.innerHTML = '<option value="">All Categories</option>';
                    
                    categoriesList.forEach(cat => {
                        const option1 = document.createElement('option');
                        option1.value = cat.id;
                        option1.textContent = cat.name;
                        select.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = cat.id;
                        option2.textContent = cat.name;
                        filterSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }
        
        async function editMedicine(id) {
            try {
                if (typeof apiService !== 'undefined') {
                    const response = await apiService.getMedicineById(id);
                    const medicine = response.medicine || response;
                    
                    if (!medicine) {
                        if (typeof showNotification === 'function') {
                            showNotification('Medicine not found', 'error');
                        }
                        return;
                    }
                    
                    editingMedicineId = id;
                    document.getElementById('medicineModalTitle').textContent = 'Edit Medicine';
                    document.getElementById('medicineName').value = medicine.name || '';
                    document.getElementById('medicineDescription').value = medicine.description || '';
                    document.getElementById('medicinePrice').value = medicine.price || '';
                    document.getElementById('medicineStock').value = medicine.stock || '';
                    document.getElementById('medicineCategory').value = medicine.category_id || medicine.categoryId || '';
                    document.getElementById('medicineRating').value = medicine.rating || 4.0;
                    document.getElementById('medicineImage').value = medicine.image || 'üíä';
                    
                    openModal(document.getElementById('medicineModal'));
                } else {
                    throw new Error('API service not available');
                }
            } catch (error) {
                console.error('Failed to load medicine:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to load medicine. Please try again.', 'error');
                }
            }
        }
        
        async function deleteMedicine(id) {
            if (!confirm('Are you sure you want to delete this medicine?')) return;
            
            try {
                if (typeof apiService !== 'undefined') {
                    await apiService.deleteMedicine(id);
                    await loadMedicinesTable();
                    if (typeof showNotification === 'function') {
                        showNotification('Medicine deleted successfully', 'success');
                    }
                } else {
                    throw new Error('API service not available');
                }
            } catch (error) {
                console.error('Failed to delete medicine:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to delete medicine. Please try again.', 'error');
                }
            }
        }
        
        async function handleMedicineSubmit(e) {
            e.preventDefault();
            
            const medicineData = {
                name: document.getElementById('medicineName').value,
                description: document.getElementById('medicineDescription').value,
                price: parseFloat(document.getElementById('medicinePrice').value),
                stock: parseInt(document.getElementById('medicineStock').value),
                categoryId: parseInt(document.getElementById('medicineCategory').value),
                rating: parseFloat(document.getElementById('medicineRating').value),
                image: document.getElementById('medicineImage').value || 'üíä'
            };
            
            try {
                if (typeof apiService !== 'undefined') {
                    if (typeof showLoading === 'function') {
                        showLoading();
                    }
                    
                    if (editingMedicineId) {
                        // Update existing medicine
                        await apiService.updateMedicine(editingMedicineId, medicineData);
                        if (typeof showNotification === 'function') {
                            showNotification('Medicine updated successfully', 'success');
                        }
                    } else {
                        // Create new medicine (ID will be auto-generated by database)
                        await apiService.createMedicine(medicineData);
                        if (typeof showNotification === 'function') {
                            showNotification('Medicine added successfully', 'success');
                        }
                    }
                    
                    closeModal(document.getElementById('medicineModal'));
                    await loadMedicinesTable();
                    
                    // Reload medicines in main script
                    if (typeof loadMedicines === 'function') {
                        await loadMedicines();
                    }
                } else {
                    throw new Error('API service not available');
                }
            } catch (error) {
                console.error('Failed to save medicine:', error);
                if (typeof showNotification === 'function') {
                    showNotification(error.message || 'Failed to save medicine. Please try again.', 'error');
                }
            } finally {
                if (typeof hideLoading === 'function') {
                    hideLoading();
                }
            }
        }
        
        async function filterMedicinesTable() {
            const search = document.getElementById('medicineSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('medicineCategoryFilter').value;
            const tbody = document.getElementById('medicinesTableBody');
            
            try {
                // Load medicines from database with filters
                const filters = {};
                if (search) filters.search = search;
                if (categoryFilter) filters.categoryId = categoryFilter;
                
                if (typeof apiService !== 'undefined') {
                    const data = await apiService.getMedicines(filters);
                    const medicinesList = data.medicines || data || [];
                    
                    if (medicinesList.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No medicines found.</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = medicinesList.map(med => `
                        <tr>
                            <td>${med.id}</td>
                            <td><strong>${med.name}</strong></td>
                            <td>${med.category_name || med.category || 'N/A'}</td>
                            <td>PKR ${med.price}</td>
                            <td><span class="stock-badge ${med.stock < 20 ? 'low-stock' : ''}">${med.stock || 0}</span></td>
                            <td>${med.sales || 0}</td>
                            <td>${med.rating || 0} ‚≠ê</td>
                            <td>
                                <button class="btn-edit-small" onclick="editMedicine(${med.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete-small" onclick="deleteMedicine(${med.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">API service not available</td></tr>';
                }
            } catch (error) {
                console.error('Failed to filter medicines:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Error loading medicines. Please try again.</td></tr>';
            }
        }
    </script>
</body>
</html>

