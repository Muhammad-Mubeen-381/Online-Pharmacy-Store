<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Admin Panel</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="nav-logo" onclick="window.location.href='index.html'">
                <i class="fas fa-pills"></i>
                <span>PharmaStore</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="manage-medicines.html" class="nav-link">Medicines</a>
                <a href="manage-orders.html" class="nav-link">Orders</a>
                <a href="manage-users.html" class="nav-link active">Users</a>
                <a href="manage-categories.html" class="nav-link">Categories</a>
                <a href="inventory.html" class="nav-link">Inventory</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
                <div class="nav-actions">
                    <div class="admin-menu" id="adminMenu" style="display: none;">
                        <div class="user-dropdown">
                            <button class="admin-profile-btn" id="adminProfileBtn">
                                <i class="fas fa-user-shield"></i>
                                <span id="adminName"></span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown-menu" id="adminDropdownMenu">
                                <button class="dropdown-item" id="adminLogoutBtn">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Manage Users Section -->
    <section class="admin-section">
        <div class="container">
            <h2 class="section-title">
                <i class="fas fa-users"></i> Manage Users
            </h2>
            
            <div class="admin-search-bar">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="userSearch" placeholder="Search users..." class="search-box">
                </div>
            </div>
            
            <div class="users-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Orders</th>
                            <th>Addresses</th>
                            <th>Total Spent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 PharmaStore. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- User Details Modal -->
    <div class="modal" id="userDetailsModal">
        <div class="modal-content">
            <span class="close" id="closeUserDetails">&times;</span>
            <h2>User Details</h2>
            <div id="userDetailsContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <script src="../js/api-service.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup event listeners first
            if (typeof setupEventListeners === 'function') {
                setupEventListeners();
            }
            
            // Check auth to show admin menu
            if (typeof checkAuth === 'function') {
                checkAuth();
            }
            
            // Initialize app
            if (typeof initializeApp === 'function') {
                await initializeApp();
            }
            
            // Load users from database
            await loadUsersTable();
            
            document.getElementById('userSearch').addEventListener('input', filterUsersTable);
        });
        
        async function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Loading users...</td></tr>';
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                // Load users from database
                const usersResponse = await apiService.getUsers();
                const users = usersResponse.users || usersResponse || [];
                
                // Load all orders and addresses once to calculate stats
                let orders = [];
                let addresses = [];
                try {
                    const ordersResponse = await apiService.getOrders();
                    orders = ordersResponse.orders || ordersResponse || [];
                } catch (error) {
                    console.error('Failed to load orders:', error);
                }
                try {
                    const addressesResponse = await apiService.getAddresses();
                    addresses = addressesResponse.addresses || addressesResponse || [];
                } catch (error) {
                    console.error('Failed to load addresses:', error);
                }
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No users found.</td></tr>';
                    return;
                }
                
                // Calculate stats for each user
                const usersWithStats = users.map((user) => {
                    const userOrders = orders.filter(o => o.user_id === user.id || o.user_email === user.email);
                    const userAddresses = addresses.filter(a => a.user_id === user.id);
                    const totalSpent = userOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
                    
                    return {
                        ...user,
                        ordersCount: userOrders.length,
                        addressesCount: userAddresses.length,
                        totalSpent: totalSpent
                    };
                });
                
                tbody.innerHTML = usersWithStats.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>${user.ordersCount || 0}</td>
                        <td>${user.addressesCount || 0}</td>
                        <td>PKR ${(user.totalSpent || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn-view-small" onclick="viewUserDetails(${user.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn-delete-small" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users table:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-error">Failed to load users. Please refresh.</td></tr>';
            }
        }
        
            function filterUsersTable() {
            const search = document.getElementById('userSearch').value
                .trim()
                .toLowerCase();

            const rows = document.querySelectorAll('#usersTableBody tr');

            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const email = row.cells[1]?.textContent.toLowerCase() || '';

                row.style.display =
                    search === '' ||
                    name.startsWith(search) ||
                    email.startsWith(search)
                        ? ''
                        : 'none';
            });
}

        
        async function viewUserDetails(userId) {
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                const userResponse = await apiService.getUserById(userId);
                const user = userResponse.user || userResponse;
                
                if (!user) {
                    if (typeof showNotification === 'function') {
                        showNotification('User not found', 'error');
                    }
                    return;
                }
                
                // Load user orders
                let userOrders = [];
                try {
                    const ordersResponse = await apiService.getOrders();
                    const allOrders = ordersResponse.orders || ordersResponse || [];
                    userOrders = allOrders.filter(o => o.user_id === user.id || o.user_email === user.email);
                } catch (error) {
                    console.error('Failed to load user orders:', error);
                }
                
                // Load user addresses
                let userAddresses = [];
                try {
                    const addressesResponse = await apiService.getAddresses();
                    const allAddresses = addressesResponse.addresses || addressesResponse || [];
                    userAddresses = allAddresses.filter(a => a.user_id === user.id);
                } catch (error) {
                    console.error('Failed to load user addresses:', error);
                }
                
                const totalSpent = userOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
            
                const modal = document.getElementById('userDetailsModal');
                const content = document.getElementById('userDetailsContent');
                
                content.innerHTML = `
                    <div class="user-details-info">
                        <div class="detail-row">
                            <span><strong>Name:</strong></span>
                            <span>${user.name}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Email:</strong></span>
                            <span>${user.email}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Phone:</strong></span>
                            <span>${user.phone || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Total Orders:</strong></span>
                            <span>${userOrders.length}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Total Spent:</strong></span>
                            <span>PKR ${totalSpent.toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Saved Addresses:</strong></span>
                            <span>${userAddresses.length}</span>
                        </div>
                    </div>
                    ${userOrders.length > 0 ? `
                        <h3>Recent Orders</h3>
                        <div class="user-orders-list">
                            ${userOrders.slice(0, 5).map(order => `
                                <div class="user-order-item">
                                    <span>Order #${order.id}</span>
                                    <span>PKR ${parseFloat(order.total || 0).toFixed(2)}</span>
                                    <span class="order-status status-${order.status || 'pending'}">${(order.status || 'pending').toUpperCase()}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                if (typeof openModal === 'function') {
                    openModal(modal);
                } else {
                    modal.classList.add('show');
                }
            } catch (error) {
                console.error('Failed to load user details:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to load user details. Please try again.', 'error');
                }
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                await apiService.deleteUser(userId);
                await loadUsersTable();
                if (typeof showNotification === 'function') {
                    showNotification('User deleted successfully', 'success');
                }
            } catch (error) {
                console.error('Failed to delete user:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to delete user. Please try again.', 'error');
                }
            }
        }
    </script>
</body>
</html>

