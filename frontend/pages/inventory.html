<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - Admin Panel</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="nav-logo" onclick="window.location.href='index.html'">
                <i class="fas fa-pills"></i>
                <span>PharmaStore</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="manage-medicines.html" class="nav-link">Medicines</a>
                <a href="manage-orders.html" class="nav-link">Orders</a>
                <a href="manage-users.html" class="nav-link">Users</a>
                <a href="manage-categories.html" class="nav-link">Categories</a>
                <a href="inventory.html" class="nav-link active">Inventory</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
                <div class="nav-actions">
                    <div class="admin-menu" id="adminMenu" style="display: none;">
                        <div class="user-dropdown">
                            <button class="admin-profile-btn" id="adminProfileBtn">
                                <i class="fas fa-user-shield"></i>
                                <span id="adminName"></span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown-menu" id="adminDropdownMenu">
                                <button class="dropdown-item" id="adminLogoutBtn">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Inventory Section -->
    <section class="admin-section">
        <div class="container">
            <h2 class="section-title">
                <i class="fas fa-boxes"></i> Inventory Management
            </h2>
            
            <div class="inventory-stats">
                <div class="stat-card-small">
                    <i class="fas fa-box"></i>
                    <div>
                        <h3 id="totalItems">0</h3>
                        <p>Total Items</p>
                    </div>
                </div>
                <div class="stat-card-small warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <h3 id="lowStockItems">0</h3>
                        <p>Low Stock Items</p>
                    </div>
                </div>
                <div class="stat-card-small success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <h3 id="inStockItems">0</h3>
                        <p>In Stock</p>
                    </div>
                </div>
                <div class="stat-card-small danger">
                    <i class="fas fa-times-circle"></i>
                    <div>
                        <h3 id="outOfStockItems">0</h3>
                        <p>Out of Stock</p>
                    </div>
                </div>
            </div>
            
            <div class="inventory-filters">
                <button class="filter-btn active" data-filter="all">All Items</button>
                <button class="filter-btn" data-filter="low">Low Stock</button>
                <button class="filter-btn" data-filter="out">Out of Stock</button>
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="inventorySearch" placeholder="Search..." class="search-box">
                </div>
            </div>
            
            <div class="inventory-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Medicine</th>
                            <th>Category</th>
                            <th>Current Stock</th>
                            <th>Low Stock Threshold</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- Inventory items will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 PharmaStore. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Update Stock Modal -->
    <div class="modal" id="updateStockModal">
        <div class="modal-content">
            <span class="close" id="closeStockModal">&times;</span>
            <h2>Update Stock</h2>
            <form id="updateStockForm">
                <div class="form-group">
                    <label id="stockMedicineName">Medicine Name</label>
                </div>
                <div class="form-group">
                    <label for="stockQuantity">New Stock Quantity *</label>
                    <input type="number" id="stockQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="lowStockThreshold">Low Stock Threshold</label>
                    <input type="number" id="lowStockThreshold" min="0" value="20">
                </div>
                <button type="submit" class="btn-primary">Update Stock</button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <script src="../js/api-service.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/script.js"></script>
    <script>
        let updatingMedicineId = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup event listeners first
            if (typeof setupEventListeners === 'function') {
                setupEventListeners();
            }
            
            // Check auth to show admin menu
            if (typeof checkAuth === 'function') {
                checkAuth();
            }
            
            // Initialize app
            if (typeof initializeApp === 'function') {
                await initializeApp();
            }
            
            // Load inventory from database
            await loadInventory();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filter = btn.getAttribute('data-filter');
                    filterInventory(filter);
                });
            });
            
            document.getElementById('inventorySearch').addEventListener('input', () => {
                filterInventory(document.querySelector('.filter-btn.active').getAttribute('data-filter'));
            });
            
            document.getElementById('updateStockForm').addEventListener('submit', handleStockUpdate);
        });
        
        async function loadInventory() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading inventory...</td></tr>';
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                const response = await apiService.getMedicines();
                const medicines = response.medicines || response || [];
                
                updateInventoryStats(medicines);
                displayInventoryTable(medicines);
            } catch (error) {
                console.error('Failed to load inventory:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-error">Failed to load inventory. Please refresh.</td></tr>';
            }
        }
        
        function updateInventoryStats(medicines) {
            const total = medicines.length;
            const lowStock = medicines.filter(m => (m.stock || 0) < 20 && (m.stock || 0) > 0).length;
            const inStock = medicines.filter(m => (m.stock || 0) >= 20).length;
            const outOfStock = medicines.filter(m => (m.stock || 0) === 0).length;
            
            document.getElementById('totalItems').textContent = total;
            document.getElementById('lowStockItems').textContent = lowStock;
            document.getElementById('inStockItems').textContent = inStock;
            document.getElementById('outOfStockItems').textContent = outOfStock;
        }
        
        function displayInventoryTable(medicines) {
            const tbody = document.getElementById('inventoryTableBody');
            
            if (medicines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No medicines found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = medicines.map(med => {
                const stock = parseInt(med.stock) || 0;
                let status = 'in-stock';
                let statusText = 'In Stock';
                
                if (stock === 0) {
                    status = 'out-of-stock';
                    statusText = 'Out of Stock';
                } else if (stock < 20) {
                    status = 'low-stock';
                    statusText = 'Low Stock';
                }
                
                return `
                    <tr>
                        <td><strong>${med.name}</strong></td>
                        <td>${med.category_name || med.category || 'N/A'}</td>
                        <td><span class="stock-value">${stock}</span></td>
                        <td>20</td>
                        <td><span class="stock-status ${status}">${statusText}</span></td>
                        <td>
                            <button class="btn-update-stock" onclick="openUpdateStockModal(${med.id})">
                                <i class="fas fa-edit"></i> Update
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function filterInventory(filter) {
            const search = document.getElementById('inventorySearch').value.toLowerCase();
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                const response = await apiService.getMedicines();
                let medicines = response.medicines || response || [];
                
                // Apply filters
                if (filter === 'low') {
                    medicines = medicines.filter(m => (m.stock || 0) < 20 && (m.stock || 0) > 0);
                } else if (filter === 'out') {
                    medicines = medicines.filter(m => (m.stock || 0) === 0);
                }
                
                if (search) {
                    medicines = medicines.filter(m => m.name.toLowerCase().includes(search));
                }
                
                displayInventoryTable(medicines);
            } catch (error) {
                console.error('Failed to filter inventory:', error);
            }
        }
        
        async function openUpdateStockModal(id) {
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                const response = await apiService.getMedicineById(id);
                const medicine = response.medicine || response;
                
                if (!medicine) {
                    if (typeof showNotification === 'function') {
                        showNotification('Medicine not found', 'error');
                    }
                    return;
                }
                
                updatingMedicineId = id;
                document.getElementById('stockMedicineName').textContent = medicine.name;
                document.getElementById('stockQuantity').value = medicine.stock || 0;
                document.getElementById('lowStockThreshold').value = 20;
                
                if (typeof openModal === 'function') {
                    openModal(document.getElementById('updateStockModal'));
                } else {
                    document.getElementById('updateStockModal').classList.add('show');
                }
            } catch (error) {
                console.error('Failed to load medicine:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to load medicine. Please try again.', 'error');
                }
            }
        }
        
        async function handleStockUpdate(e) {
            e.preventDefault();
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                const newStock = parseInt(document.getElementById('stockQuantity').value);
                
                await apiService.updateMedicine(updatingMedicineId, { stock: newStock });
                
                if (typeof closeModal === 'function') {
                    closeModal(document.getElementById('updateStockModal'));
                } else {
                    document.getElementById('updateStockModal').classList.remove('show');
                }
                
                await loadInventory();
                
                // Reload medicines in main script
                if (typeof loadMedicines === 'function') {
                    await loadMedicines();
                }
                
                if (typeof showNotification === 'function') {
                    showNotification('Stock updated successfully', 'success');
                }
            } catch (error) {
                console.error('Failed to update stock:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to update stock. Please try again.', 'error');
                }
            }
        }
    </script>
</body>
</html>

