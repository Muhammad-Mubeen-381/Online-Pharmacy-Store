<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Categories - Admin Panel</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="nav-logo" onclick="window.location.href='index.html'">
                <i class="fas fa-pills"></i>
                <span>PharmaStore</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="manage-medicines.html" class="nav-link">Medicines</a>
                <a href="manage-orders.html" class="nav-link">Orders</a>
                <a href="manage-users.html" class="nav-link">Users</a>
                <a href="manage-categories.html" class="nav-link active">Categories</a>
                <a href="inventory.html" class="nav-link">Inventory</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
                <div class="nav-actions">
                    <div class="admin-menu" id="adminMenu" style="display: none;">
                        <div class="user-dropdown">
                            <button class="admin-profile-btn" id="adminProfileBtn">
                                <i class="fas fa-user-shield"></i>
                                <span id="adminName"></span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown-menu" id="adminDropdownMenu">
                                <button class="dropdown-item" id="adminLogoutBtn">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Manage Categories Section -->
    <section class="admin-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-tags"></i> Manage Categories
                </h2>
                <button class="btn-primary" id="addCategoryBtn">
                    <i class="fas fa-plus"></i> Add New Category
                </button>
            </div>
            
            <div class="categories-grid-admin" id="categoriesGrid">
                <!-- Categories will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 PharmaStore. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Add/Edit Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="close" id="closeCategoryModal">&times;</span>
            <h2 id="categoryModalTitle">Add New Category</h2>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName">Category Name *</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Description</label>
                    <textarea id="categoryDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryIcon">Icon Emoji</label>
                    <input type="text" id="categoryIcon" placeholder="ðŸ’Š" maxlength="2">
                </div>
                <button type="submit" class="btn-primary">Save Category</button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <script src="../js/api-service.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/script.js"></script>
    <script>
        let editingCategoryId = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup event listeners first
            if (typeof setupEventListeners === 'function') {
                setupEventListeners();
            }
            
            // Check auth to show admin menu
            if (typeof checkAuth === 'function') {
                checkAuth();
            }
            
            // Initialize app
            if (typeof initializeApp === 'function') {
                await initializeApp();
            }
            
            // Load categories from database
            await loadCategoriesGrid();
            
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                editingCategoryId = null;
                document.getElementById('categoryModalTitle').textContent = 'Add New Category';
                document.getElementById('categoryForm').reset();
                openModal(document.getElementById('categoryModal'));
            });
            
            document.getElementById('categoryForm').addEventListener('submit', handleCategorySubmit);
        });
        
        async function loadCategoriesGrid() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = '<div class="empty-state"><p>Loading categories...</p></div>';
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                // Load categories and medicines from database
                const [categoriesResponse, medicinesResponse] = await Promise.all([
                    apiService.getCategories(),
                    apiService.getMedicines()
                ]);
                
                const categories = categoriesResponse.categories || categoriesResponse || [];
                const medicines = medicinesResponse.medicines || medicinesResponse || [];
                
                if (categories.length === 0) {
                    grid.innerHTML = '<div class="empty-state"><p>No categories found. Add your first category!</p></div>';
                    return;
                }
                
                grid.innerHTML = categories.map(cat => {
                    const categoryMedicines = medicines.filter(m => (m.category_id || m.categoryId) == cat.id);
                    return `
                        <div class="category-card-admin">
                            <div class="category-icon-admin">${cat.icon || 'ðŸ’Š'}</div>
                            <h3>${cat.name}</h3>
                            <p>${categoryMedicines.length} medicines</p>
                            <div class="category-actions">
                                <button class="btn-edit" onclick="editCategory(${cat.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-delete" onclick="deleteCategory(${cat.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load categories:', error);
                grid.innerHTML = '<div class="empty-state"><p class="text-error">Failed to load categories. Please refresh.</p></div>';
            }
        }
        
        async function editCategory(id) {
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                const response = await apiService.getCategoryById(id);
                const category = response.category || response;
                
                if (!category) {
                    if (typeof showNotification === 'function') {
                        showNotification('Category not found', 'error');
                    }
                    return;
                }
                
                editingCategoryId = id;
                document.getElementById('categoryModalTitle').textContent = 'Edit Category';
                document.getElementById('categoryName').value = category.name || '';
                document.getElementById('categoryDescription').value = category.description || '';
                document.getElementById('categoryIcon').value = category.icon || 'ðŸ’Š';
                
                if (typeof openModal === 'function') {
                    openModal(document.getElementById('categoryModal'));
                } else {
                    document.getElementById('categoryModal').classList.add('show');
                }
            } catch (error) {
                console.error('Failed to load category:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to load category. Please try again.', 'error');
                }
            }
        }
        
        async function deleteCategory(id) {
            if (!confirm('Are you sure you want to delete this category? Medicines in this category will be uncategorized.')) return;
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                await apiService.deleteCategory(id);
                await loadCategoriesGrid();
                
                // Reload categories in main script
                if (typeof loadCategories === 'function') {
                    await loadCategories();
                }
                
                if (typeof showNotification === 'function') {
                    showNotification('Category deleted successfully', 'success');
                }
            } catch (error) {
                console.error('Failed to delete category:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to delete category. Please try again.', 'error');
                }
            }
        }
        
        async function handleCategorySubmit(e) {
            e.preventDefault();
            
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                icon: document.getElementById('categoryIcon').value || 'ðŸ’Š'
            };
            
            try {
                if (typeof apiService === 'undefined') {
                    throw new Error('API service not available');
                }
                
                if (typeof showLoading === 'function') {
                    showLoading();
                }
                
                if (editingCategoryId) {
                    // Update existing category
                    await apiService.updateCategory(editingCategoryId, categoryData);
                    if (typeof showNotification === 'function') {
                        showNotification('Category updated successfully', 'success');
                    }
                } else {
                    // Create new category (ID will be auto-generated by database)
                    await apiService.createCategory(categoryData);
                    if (typeof showNotification === 'function') {
                        showNotification('Category added successfully', 'success');
                    }
                }
                
                if (typeof closeModal === 'function') {
                    closeModal(document.getElementById('categoryModal'));
                } else {
                    document.getElementById('categoryModal').classList.remove('show');
                }
                
                await loadCategoriesGrid();
                
                // Reload categories in main script
                if (typeof loadCategories === 'function') {
                    await loadCategories();
                }
            } catch (error) {
                console.error('Failed to save category:', error);
                if (typeof showNotification === 'function') {
                    showNotification(error.message || 'Failed to save category. Please try again.', 'error');
                }
            } finally {
                if (typeof hideLoading === 'function') {
                    hideLoading();
                }
            }
        }
    </script>
</body>
</html>

